<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="·ª®ng d·ª•ng Kinh D·ªãch AI - Lu·∫≠n gi·∫£i qu·∫ª b·∫±ng tr√≠ tu·ªá nh√¢n t·∫°o">
    <meta name="keywords" content="kinh d·ªãch, b√≥i to√°n, ai, tr√≠ tu·ªá nh√¢n t·∫°o">
    <title>Kinh D·ªãch AI - Lu·∫≠n Gi·∫£i Tr√≠ Tu·ªá</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #fef5e7 0%, #fdeaa3 50%, #f8d7da 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        .lotus-bg {
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(219, 39, 119, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(167, 139, 250, 0.03) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M60 15 C45 15 45 30 60 45 C75 30 75 15 60 15 M60 105 C45 105 45 90 60 75 C75 90 75 105 60 105 M15 60 C15 45 30 45 45 60 C30 75 15 75 15 60 M105 60 C105 45 90 45 75 60 C90 75 105 75 105 60' fill='none' stroke='%23dc2626' stroke-width='0.5' opacity='0.15'/%3E%3C/svg%3E");
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { text-align: center; margin-bottom: 2.5rem; padding-top: 2rem; position: relative; }
        .header::before, .header::after { content: 'üêâ'; position: absolute; font-size: 3rem; opacity: 0.2; }
        .header::before { left: 5%; top: 0; }
        .header::after { content: 'ü¶ö'; right: 5%; top: 0; }
        .title { font-size: 3.5rem; font-weight: 700; background: linear-gradient(90deg, #dc2626, #c2410c, #b91c1c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.75rem; }
        .subtitle { font-size: 1.4rem; color: #7f1d1d; font-weight: 600; margin-bottom: 0.5rem; }
        .description { font-size: 1rem; color: #92400e; font-style: italic; }
        .card { background: white; border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 25px 60px rgba(185, 28, 28, 0.2); border: 5px solid; border-image: linear-gradient(135deg, #dc2626, #f59e0b, #dc2626) 1; margin-bottom: 2rem; position: relative; }
        .card::before, .card::after { content: 'ü™∑'; position: absolute; font-size: 2rem; opacity: 0.15; }
        .card::before { top: 10px; left: 10px; }
        .card::after { bottom: 10px; right: 10px; }
        .card-header { font-size: 1.75rem; font-weight: 700; color: #7f1d1d; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 3px solid #fecaca; text-align: center; }
        .form-group { margin-bottom: 2rem; }
        .label { display: block; font-size: 1.25rem; font-weight: 700; color: #991b1b; margin-bottom: 0.75rem; }
        .input, .textarea { width: 100%; padding: 1.25rem; border: 3px solid #fecaca; border-radius: 1rem; font-size: 1.125rem; font-family: 'Crimson Text', serif; transition: all 0.3s; }
        .input:focus, .textarea:focus { outline: none; border-color: #dc2626; box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        .input.error, .textarea.error { border-color: #dc2626; }
        .textarea { min-height: 160px; resize: vertical; }
        .hint { font-size: 0.875rem; color: #92400e; margin-top: 0.5rem; font-style: italic; }
        .error-hint { color: #dc2626; font-weight: 600; }
        .char-count { float: right; font-size: 0.875rem; color: #6b7280; }
        .char-count.warning { color: #f59e0b; }
        .char-count.error { color: #dc2626; }
        
        .button-group { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .btn { padding: 1.5rem 2.5rem; border-radius: 1rem; font-weight: 700; font-size: 1.25rem; cursor: pointer; border: none; transition: all 0.3s; position: relative; }
        .btn-primary { flex: 1; background: linear-gradient(135deg, #dc2626, #f59e0b); color: white; box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 15px 40px rgba(220, 38, 38, 0.5); transform: translateY(-3px); }
        .btn-primary:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .btn-secondary { padding: 1.5rem 2.5rem; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #374151; }
        
        /* Progress bar */
        .progress-container { margin: 1.5rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #dc2626, #f59e0b); transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 0.5rem; font-size: 0.95rem; color: #6b7280; }
        
        .hexagram-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 2.5rem; }
        .hexagram-card { padding: 2.5rem; border-radius: 1.5rem; border: 4px solid; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); text-align: center; }
        .hexagram-main { background: linear-gradient(135deg, #fef2f2, #fed7aa); border-color: #dc2626; }
        .hexagram-changed { background: linear-gradient(135deg, #eff6ff, #e0e7ff); border-color: #3b82f6; }
        .hexagram-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; }
        .hexagram-visual { margin: 1.5rem 0; display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }
        .hexagram-line { width: 80%; height: 12px; border-radius: 6px; transition: all 0.3s; }
        .hexagram-line.yang { background: linear-gradient(90deg, #dc2626, #991b1b); box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3); }
        .hexagram-line.yin { display: flex; gap: 8%; }
        .hexagram-line.yin::before, .hexagram-line.yin::after { content: ''; flex: 1; background: linear-gradient(90deg, #1e40af, #1e3a8a); border-radius: 6px; box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3); }
        .hexagram-line.changing { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }
        .hexagram-name { font-size: 2.25rem; font-weight: 700; margin: 1rem 0; }
        .hexagram-number { font-size: 1rem; color: #6b7280; background: rgba(255, 255, 255, 0.8); display: inline-block; padding: 0.5rem 1.25rem; border-radius: 1.5rem; margin: 0.5rem 0; border: 2px solid currentColor; }
        .hexagram-meaning { color: #374151; margin: 1rem 0; font-size: 1.125rem; line-height: 1.6; }
        .hexagram-tags { display: flex; gap: 0.75rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
        .tag { padding: 0.75rem 1.5rem; background: white; border-radius: 1.5rem; font-size: 1rem; font-weight: 700; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border: 2px solid currentColor; }
        .extra-info { margin-top: 1.5rem; padding: 1.5rem; background: rgba(255, 255, 255, 0.7); border-radius: 1rem; font-size: 0.95rem; line-height: 1.6; }
        .extra-info-title { font-weight: 700; color: #7f1d1d; margin-bottom: 0.5rem; }
        .changing-line { padding: 2rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 1.5rem; border: 4px solid #f59e0b; text-align: center; font-weight: 700; font-size: 1.5rem; color: #78350f; margin-bottom: 2.5rem; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3); }
        .interpretation { padding: 2.5rem; background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 1.5rem; border-left: 6px solid #7c3aed; color: #1f2937; font-size: 1.25rem; line-height: 2.2; text-align: justify; white-space: pre-wrap; box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05); }
        .note { margin-top: 2.5rem; padding: 2rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 1.5rem; border: 3px solid #f59e0b; }
        .note-text { font-size: 1rem; color: #78350f; line-height: 1.8; }
        .spinner { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        .error-message { padding: 1.5rem; background: #fee2e2; border: 3px solid #dc2626; border-radius: 1rem; color: #991b1b; margin-top: 1rem; }
        .success-badge { display: inline-block; padding: 0.5rem 1rem; background: #d1fae5; color: #065f46; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; margin-left: 1rem; }
        .cache-badge { display: inline-block; padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 0.5rem; font-size: 0.75rem; margin-left: 0.5rem; }
        
        @media (max-width: 768px) { .title { font-size: 2.5rem; } .hexagram-grid { grid-template-columns: 1fr; } }
        
        /* Accessibility improvements */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }
        *:focus-visible { outline: 3px solid #dc2626; outline-offset: 2px; }
    </style>
</head>
<body class="lotus-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // ‚úÖ 6. CACHE UTILITY
        const CacheManager = {
            set: (key, value, ttl = 3600000) => { // 1 hour default
                const item = {
                    value,
                    expires: Date.now() + ttl
                };
                try {
                    localStorage.setItem(`cache_${key}`, JSON.stringify(item));
                } catch (e) {
                    console.error('Cache set error:', e);
                }
            },
            get: (key) => {
                try {
                    const item = localStorage.getItem(`cache_${key}`);
                    if (!item) return null;
                    
                    const parsed = JSON.parse(item);
                    if (Date.now() > parsed.expires) {
                        localStorage.removeItem(`cache_${key}`);
                        return null;
                    }
                    return parsed.value;
                } catch (e) {
                    return null;
                }
            },
            clear: () => {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('cache_')) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (e) {
                    console.error('Cache clear error:', e);
                }
            }
        };

        function KinhDichApp() {
            const [datetime, setDatetime] = useState('');
            const [question, setQuestion] = useState('');
            const [hexagram, setHexagram] = useState(null);
            const [isCalculating, setIsCalculating] = useState(false);
            const [aiInterpretation, setAiInterpretation] = useState('');
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [loadingStatus, setLoadingStatus] = useState('');
            const [error, setError] = useState('');
            const [questionError, setQuestionError] = useState('');
            const [isCached, setIsCached] = useState(false);
            
            // ‚úÖ 8. DEBOUNCE REF
            const debounceTimer = useRef(null);

            const hexagrams = {
                1: { name: 'C√†n Vi Thi√™n', meaning: 'Qu·∫ª thu·∫ßn D∆∞∆°ng, bi·ªÉu t∆∞·ª£ng tr·ªùi', element: 'Kim', palace: 'C√†n', shiYao: 4 },
                2: { name: 'Kh√¥n Vi ƒê·ªãa', meaning: 'Qu·∫ª thu·∫ßn √Çm, bi·ªÉu t∆∞·ª£ng ƒë·∫•t', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 1 },
                3: { name: 'Th·ªßy L√¥i Tru√¢n', meaning: 'Kh√≥ khƒÉn ban ƒë·∫ßu, ki√™n tr√¨', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 2 },
                4: { name: 'S∆°n Th·ªßy M√¥ng', meaning: 'Tr·∫ª th∆° m·ªù m·ªãt, c·∫ßn h·ªçc', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
                5: { name: 'Th·ªßy Thi√™n Nhu', meaning: 'Ch·ªù ƒë·ª£i th·ªùi c∆°', element: 'Th·ªßy', palace: 'C√†n', shiYao: 5 },
                6: { name: 'Thi√™n Th·ªßy T·ª•ng', meaning: 'Tranh t·ª•ng, c·∫ßn h√≤a gi·∫£i', element: 'Kim', palace: 'C√†n', shiYao: 5 },
                7: { name: 'ƒê·ªãa Th·ªßy S∆∞', meaning: 'ƒê·ªôi qu√¢n c√≥ k·ª∑ lu·∫≠t', element: 'Th·ªßy', palace: 'Kh√¥n', shiYao: 2 },
                8: { name: 'Th·ªßy ƒê·ªãa T·ª∑', meaning: 'Th√¢n c·∫≠n ƒëo√†n k·∫øt', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 5 },
                9: { name: 'Phong Thi√™n Ti·ªÉu S√∫c', meaning: 'S√∫c d∆∞·ª°ng nh·ªè', element: 'M·ªôc', palace: 'C√†n', shiYao: 4 },
                10: { name: 'Thi√™n Tr·∫°ch L√Ω', meaning: 'Gi·∫´m ƒëu√¥i h·ªï', element: 'Kim', palace: 'C√†n', shiYao: 3 },
                11: { name: 'ƒê·ªãa Thi√™n Th√°i', meaning: 'Th√¥ng su·ªët th·ªãnh v∆∞·ª£ng', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 3 },
                12: { name: 'Thi√™n ƒê·ªãa Bƒ©', meaning: 'T·∫Øc ngh·∫Ωn b·∫ø t·∫Øc', element: 'Th·ªï', palace: 'C√†n', shiYao: 3 },
                13: { name: 'Thi√™n H·ªèa ƒê·ªìng Nh√¢n', meaning: 'ƒêo√†n k·∫øt v·ªõi ng∆∞·ªùi', element: 'H·ªèa', palace: 'C√†n', shiYao: 5 },
                14: { name: 'H·ªèa Thi√™n ƒê·∫°i H·ªØu', meaning: 'S·ªü h·ªØu l·ªõn lao', element: 'Kim', palace: 'Ly', shiYao: 2 },
                15: { name: 'ƒê·ªãa S∆°n Khi√™m', meaning: 'Khi√™m t·ªën h·∫° m√¨nh', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 4 },
                16: { name: 'L√¥i ƒê·ªãa D·ª±', meaning: 'Vui v·∫ª h√†o h·ª©ng', element: 'Th·ªï', palace: 'Ch·∫•n', shiYao: 1 },
                17: { name: 'Tr·∫°ch L√¥i T√πy', meaning: 'Theo ƒëu·ªïi linh ho·∫°t', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 4 },
                18: { name: 'S∆°n Phong C·ªï', meaning: 'S·ª≠a ch·ªØa c·∫£i t·∫°o', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 5 },
                19: { name: 'ƒê·ªãa Tr·∫°ch L√¢m', meaning: 'Ti·∫øp c·∫≠n ƒë·∫øn g·∫ßn', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 5 },
                20: { name: 'Phong ƒê·ªãa Quan', meaning: 'Quan s√°t suy ng·∫´m', element: 'Th·ªï', palace: 'T·ªën', shiYao: 2 },
                21: { name: 'H·ªèa L√¥i Ph·ªá H·∫°p', meaning: 'C·∫Øn ƒë·ª©t ch∆∞·ªõng ng·∫°i', element: 'H·ªèa', palace: 'Ch·∫•n', shiYao: 4 },
                22: { name: 'S∆°n H·ªèa B√≠', meaning: 'Trang tr√≠ vƒÉn ch∆∞∆°ng', element: 'H·ªèa', palace: 'Ly', shiYao: 3 },
                23: { name: 'S∆°n ƒê·ªãa B√°c', meaning: 'B√≥c tr√≥c suy t√†n', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 6 },
                24: { name: 'ƒê·ªãa L√¥i Ph·ª•c', meaning: 'Quay tr·ªü l·∫°i ph·ª•c h·ªìi', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 4 },
                25: { name: 'Thi√™n L√¥i V√¥ V·ªçng', meaning: 'Kh√¥ng v·ªçng ƒë·ªông', element: 'Kim', palace: 'C√†n', shiYao: 6 },
                26: { name: 'S∆°n Thi√™n ƒê·∫°i S√∫c', meaning: 'S√∫c d∆∞·ª°ng l·ªõn', element: 'Kim', palace: 'C√†n', shiYao: 6 },
                27: { name: 'S∆°n L√¥i Di', meaning: 'Nu√¥i d∆∞·ª°ng sinh nhu·∫≠n', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 1 },
                28: { name: 'Tr·∫°ch Phong ƒê·∫°i Qu√°', meaning: 'Qu√° m·ª©c l·ªõn lao', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 5 },
                29: { name: 'Kh·∫£m Vi Th·ªßy', meaning: 'Thu·∫ßn Th·ªßy hi·ªÉm tr·ªü', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 2 },
                30: { name: 'Ly Vi H·ªèa', meaning: 'Thu·∫ßn H·ªèa s√°ng r·ª±c', element: 'H·ªèa', palace: 'Ly', shiYao: 5 },
                31: { name: 'Tr·∫°ch S∆°n H√†m', meaning: 'C·∫£m ·ª©ng giao thoa', element: 'Kim', palace: 'ƒêo√†i', shiYao: 3 },
                32: { name: 'L√¥i Phong H·∫±ng', meaning: 'B·ªÅn l√¢u tr∆∞·ªùng c·ª≠u', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 5 },
                33: { name: 'Thi√™n S∆°n ƒê·ªôn', meaning: 'R√∫t lui ·∫©n n√°u', element: 'Kim', palace: 'C√†n', shiYao: 3 },
                34: { name: 'L√¥i Thi√™n ƒê·∫°i Tr√°ng', meaning: 'M·∫°nh l·ªõn h√πng tr√°ng', element: 'Kim', palace: 'Ch·∫•n', shiYao: 4 },
                35: { name: 'H·ªèa ƒê·ªãa T·∫•n', meaning: 'Ti·∫øn l√™n ph√°t tri·ªÉn', element: 'H·ªèa', palace: 'Ly', shiYao: 1 },
                36: { name: 'ƒê·ªãa H·ªèa Minh Di', meaning: '√Ånh s√°ng b·ªã t·ªïn', element: 'H·ªèa', palace: 'Kh√¥n', shiYao: 2 },
                37: { name: 'Phong H·ªèa Gia Nh√¢n', meaning: 'Gia ƒë√¨nh ƒëo√†n t·ª•', element: 'H·ªèa', palace: 'Ly', shiYao: 3 },
                38: { name: 'H·ªèa Tr·∫°ch Qu·ªµ', meaning: 'Tr√°i ng∆∞·ª£c xung kh·∫Øc', element: 'H·ªèa', palace: 'ƒêo√†i', shiYao: 6 },
                39: { name: 'Th·ªßy S∆°n Ki·ªÉn', meaning: 'Kh√≥ khƒÉn ch∆∞·ªõng ng·∫°i', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
                40: { name: 'L√¥i Th·ªßy Gi·∫£i', meaning: 'Gi·∫£i tho√°t khai th√¥ng', element: 'Th·ªßy', palace: 'Ch·∫•n', shiYao: 2 },
                41: { name: 'S∆°n Tr·∫°ch T·ªïn', meaning: 'Gi·∫£m b·ªõt t·ªïn th∆∞∆°ng', element: 'Kim', palace: 'ƒêo√†i', shiYao: 2 },
                42: { name: 'Phong L√¥i √çch', meaning: 'TƒÉng √≠ch l·ª£i l·ªôc', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 1 },
                43: { name: 'Tr·∫°ch Thi√™n Qu·∫£i', meaning: 'Quy·∫øt ƒëo√°n d·ª©t kho√°t', element: 'Kim', palace: 'C√†n', shiYao: 4 },
                44: { name: 'Thi√™n Phong C·∫•u', meaning: 'G·∫∑p g·ª° kh√¥ng ng·ªù', element: 'M·ªôc', palace: 'T·ªën', shiYao: 1 },
                45: { name: 'Tr·∫°ch ƒê·ªãa T·ª•y', meaning: 'T·ª• h·ªçp ƒëo√†n t·ª•', element: 'Th·ªï', palace: 'ƒêo√†i', shiYao: 3 },
                46: { name: 'ƒê·ªãa Phong ThƒÉng', meaning: 'ThƒÉng ti·∫øn v∆∞∆°n l√™n', element: 'M·ªôc', palace: 'T·ªën', shiYao: 2 },
                47: { name: 'Tr·∫°ch Th·ªßy Kh·ªën', meaning: 'C√πng qu·∫´n kh√≥ khƒÉn', element: 'Th·ªßy', palace: 'ƒêo√†i', shiYao: 5 },
                48: { name: 'Th·ªßy Phong T·ªânh', meaning: 'Gi·∫øng n∆∞·ªõc trong l√†nh', element: 'M·ªôc', palace: 'Kh·∫£m', shiYao: 4 },
                49: { name: 'Tr·∫°ch H·ªèa C√°ch', meaning: 'C√°ch m·∫°ng ƒë·ªïi m·ªõi', element: 'H·ªèa', palace: 'Ly', shiYao: 5 },
                50: { name: 'H·ªèa Phong ƒê·ªânh', meaning: 'ƒê·ªânh n·∫•u ƒÉn', element: 'M·ªôc', palace: 'Ly', shiYao: 4 },
                51: { name: 'Ch·∫•n Vi L√¥i', meaning: 'Thu·∫ßn L√¥i ch·∫•n ƒë·ªông', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 3 },
                52: { name: 'C·∫•n Vi S∆°n', meaning: 'Thu·∫ßn S∆°n ng·ª´ng l·∫°i', element: 'Th·ªï', palace: 'C·∫•n', shiYao: 6 },
                53: { name: 'Phong S∆°n Ti·ªám', meaning: 'Ti·∫øn d·∫ßn t·ª´ng b∆∞·ªõc', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 5 },
                54: { name: 'L√¥i Tr·∫°ch Quy Mu·ªôi', meaning: 'Con g√°i v·ªÅ nh√† ch·ªìng', element: 'Kim', palace: 'Ch·∫•n', shiYao: 6 },
                55: { name: 'L√¥i H·ªèa Phong', meaning: 'Phong ph√∫ th·ªãnh ƒë·∫°i', element: 'H·ªèa', palace: 'Ch·∫•n', shiYao: 4 },
                56: { name: 'H·ªèa S∆°n L·ªØ', meaning: 'Kh√°ch l·ªØ phi√™u b·∫°t', element: 'H·ªèa', palace: 'C·∫•n', shiYao: 4 },
                57: { name: 'T·ªën Vi Phong', meaning: 'Thu·∫ßn Phong th·∫•m nh·∫≠p', element: 'M·ªôc', palace: 'T·ªën', shiYao: 1 },
                58: { name: 'ƒêo√†i Vi Tr·∫°ch', meaning: 'Thu·∫ßn Tr·∫°ch vui v·∫ª', element: 'Kim', palace: 'ƒêo√†i', shiYao: 4 },
                59: { name: 'Phong Th·ªßy Ho√°n', meaning: 'Ph√¢n t√°n tan r√£', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 6 },
                60: { name: 'Th·ªßy Tr·∫°ch Ti·∫øt', meaning: 'Ti·∫øt ƒë·ªô ch·ª´ng m·ª±c', element: 'Th·ªßy', palace: 'ƒêo√†i', shiYao: 2 },
                61: { name: 'Phong Tr·∫°ch Trung Phu', meaning: 'Trung t√≠n th√†nh th·∫≠t', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 3 },
                62: { name: 'L√¥i S∆°n Ti·ªÉu Qu√°', meaning: 'V∆∞·ª£t qu√° nh·ªè', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 6 },
                63: { name: 'Th·ªßy H·ªèa K√Ω T·∫ø', meaning: 'ƒê√£ ho√†n th√†nh', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
                64: { name: 'H·ªèa Th·ªßy V·ªã T·∫ø', meaning: 'Ch∆∞a ho√†n th√†nh', element: 'H·ªèa', palace: 'Ly', shiYao: 6 }
            };

            const hexagramTable = [
                [1, 34, 5, 26, 11, 9, 14, 43], [25, 51, 3, 27, 24, 42, 21, 17],
                [6, 40, 29, 4, 7, 59, 64, 47], [33, 62, 39, 52, 15, 53, 56, 31],
                [12, 16, 8, 23, 2, 20, 35, 45], [44, 32, 48, 18, 46, 57, 50, 28],
                [13, 55, 63, 22, 36, 37, 30, 49], [10, 54, 60, 41, 19, 61, 38, 58]
            ];

            const getTrigramIndex = (num) => num - 1;
            const getHexagramLines = (hexNumber) => {
                const hexBinary = {
                    1: [1,1,1,1,1,1], 2: [0,0,0,0,0,0], 3: [1,0,0,0,1,0], 4: [0,1,0,0,0,1], 5: [0,1,0,1,1,1], 6: [1,1,1,0,1,0], 7: [0,1,0,0,0,0], 8: [0,0,0,0,1,0],
                    9: [0,1,1,1,1,1], 10: [1,1,1,0,1,1], 11: [1,1,1,0,0,0], 12: [0,0,0,1,1,1], 13: [1,0,1,1,1,1], 14: [1,1,1,1,0,1], 15: [0,0,1,0,0,0], 16: [0,0,0,1,0,0],
                    17: [1,0,0,0,0,1], 18: [1,0,0,1,1,0], 19: [0,0,0,0,1,1], 20: [1,1,0,0,0,0], 21: [1,0,1,0,0,1], 22: [1,0,0,1,0,1], 23: [1,0,0,0,0,0], 24: [0,0,0,0,0,1],
                    25: [1,0,0,1,1,1], 26: [1,1,1,0,0,1], 27: [1,0,0,0,0,1], 28: [0,1,1,1,1,0], 29: [0,1,0,0,1,0], 30: [1,0,1,1,0,1], 31: [0,0,1,1,1,0], 32: [0,1,1,1,0,0],
                    33: [0,0,1,1,1,1], 34: [1,1,1,1,0,0], 35: [0,0,0,1,0,1], 36: [1,0,1,0,0,0], 37: [1,0,1,0,1,1], 38: [1,1,0,1,0,1], 39: [0,0,1,0,1,0], 40: [0,1,0,1,0,0],
                    41: [1,1,0,0,0,1], 42: [0,0,0,1,1,0], 43: [1,1,1,1,1,0], 44: [0,1,1,1,1,1], 45: [0,0,0,1,1,0], 46: [0,1,1,0,0,0], 47: [0,1,1,0,1,0], 48: [0,1,0,1,1,0],
                    49: [1,0,1,0,1,1], 50: [1,1,0,1,0,1], 51: [0,0,1,0,0,1], 52: [1,0,0,1,0,0], 53: [0,0,1,1,1,0], 54: [0,1,1,0,0,1], 55: [1,0,1,0,0,1], 56: [1,0,0,1,0,1],
                    57: [0,1,1,0,1,1], 58: [1,1,0,1,1,0], 59: [0,1,0,1,1,0], 60: [0,1,1,0,1,0], 61: [1,1,0,0,1,1], 62: [0,0,1,1,0,0], 63: [1,0,1,0,1,0], 64: [0,1,0,1,0,1]
                };
                return hexBinary[hexNumber] || [1,1,1,1,1,1];
            };

            // ‚úÖ 2. VALIDATE QUESTION
            const validateQuestion = useCallback((q) => {
                const trimmed = q.trim();
                
                if (trimmed.length < 5) {
                    return 'C√¢u h·ªèi qu√° ng·∫Øn (t·ªëi thi·ªÉu 5 k√Ω t·ª±)';
                }
                
                if (trimmed.length > 500) {
                    return 'C√¢u h·ªèi qu√° d√†i (t·ªëi ƒëa 500 k√Ω t·ª±)';
                }
                
                return '';
            }, []);

            // Handle question change v·ªõi validation
            const handleQuestionChange = (e) => {
                const value = e.target.value;
                setQuestion(value);
                
                if (value.trim()) {
                    const error = validateQuestion(value);
                    setQuestionError(error);
                } else {
                    setQuestionError('');
                }
            };

            const calculateHexagram = () => {
                // Validation
                if (!datetime) {
                    alert('Vui l√≤ng ch·ªçn gi·ªù ƒë·ªông t√¢m!');
                    return;
                }
                
                const questionErr = validateQuestion(question);
                if (questionErr) {
                    setQuestionError(questionErr);
                    alert(questionErr);
                    return;
                }

                setIsCalculating(true);
                setError('');

                setTimeout(() => {
                    const date = new Date(datetime);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const hour = date.getHours();
                    const minute = date.getMinutes();

                    const upperSum = (year + month + day) % 8;
                    const upperTrigram = upperSum === 0 ? 8 : upperSum;
                    const lowerSum = (year + month + day + hour) % 8;
                    const lowerTrigram = lowerSum === 0 ? 8 : lowerSum;
                    const changingLineSum = (year + month + day + hour + minute) % 6;
                    const changingLine = changingLineSum === 0 ? 6 : changingLineSum;

                    const mainHexNumber = hexagramTable[getTrigramIndex(upperTrigram)][getTrigramIndex(lowerTrigram)];
                    const mainLines = getHexagramLines(mainHexNumber);
                    const changedLines = [...mainLines];
                    changedLines[changingLine - 1] = 1 - changedLines[changingLine - 1];
                    
                    let changedHexNumber = mainHexNumber;
                    for (let i = 1; i <= 64; i++) {
                        const lines = getHexagramLines(i);
                        if (JSON.stringify(lines) === JSON.stringify(changedLines)) {
                            changedHexNumber = i;
                            break;
                        }
                    }

                    const mainHex = hexagrams[mainHexNumber];
                    const changedHex = hexagrams[changedHexNumber];
                    const yingYao = mainHex.shiYao <= 3 ? mainHex.shiYao + 3 : mainHex.shiYao - 3;

                    setHexagram({
                        mainHex: {...mainHex, lines: mainLines},
                        mainHexNumber,
                        changedHex: {...changedHex, lines: changedLines},
                        changedHexNumber,
                        changingLine,
                        shiYao: mainHex.shiYao,
                        yingYao,
                        datetime: date.toLocaleString('vi-VN'),
                        question: question.trim()
                    });
                    setIsCalculating(false);
                }, 1000);
            };

            // ‚úÖ 3. RETRY LOGIC + ‚úÖ 5. PROGRESS + ‚úÖ 6. CACHING
            const getAIInterpretation = async () => {
                if (!hexagram) return;

                // Check cache
                const cacheKey = `${hexagram.mainHexNumber}_${hexagram.changedHexNumber}_${hexagram.changingLine}_${hexagram.question}`;
                const cached = CacheManager.get(cacheKey);
                
                if (cached) {
                    setAiInterpretation(cached);
                    setIsCached(true);
                    return;
                }

                setIsLoadingAI(true);
                setError('');
                setAiInterpretation('');
                setIsCached(false);
                setLoadingProgress(0);
                setLoadingStatus('ƒêang k·∫øt n·ªëi v·ªõi AI...');

                const maxRetries = 3;
                let lastError = null;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        setLoadingProgress(20 + (attempt - 1) * 10);
                        setLoadingStatus(`ƒêang g·ª≠i y√™u c·∫ßu (l·∫ßn ${attempt}/${maxRetries})...`);

                        const response = await fetch('/api/interpret', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                question: hexagram.question,
                                datetime: hexagram.datetime,
                                mainHexName: hexagram.mainHex.name,
                                mainHexNumber: hexagram.mainHexNumber,
                                mainHexPalace: hexagram.mainHex.palace,
                                mainHexElement: hexagram.mainHex.element,
                                changedHexName: hexagram.changedHex.name,
                                changedHexNumber: hexagram.changedHexNumber,
                                changingLine: hexagram.changingLine,
                                shiYao: hexagram.shiYao,
                                yingYao: hexagram.yingYao
                            })
                        });

                        setLoadingProgress(50);
                        setLoadingStatus('ƒêang nh·∫≠n l·ªùi gi·∫£i...');

                        const data = await response.json();

                        if (!response.ok) {
                            // N·∫øu rate limit, ƒë·ª´ng retry
                            if (response.status === 429) {
                                const waitTime = data.retryAfter || 60;
                                setError(`${data.error || 'Vui l√≤ng ch·ªù'} ${waitTime}s`);
                                setIsLoadingAI(false);
                                return;
                            }

                            throw new Error(data.error || data.hint || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                        }

                        setLoadingProgress(100);
                        setLoadingStatus('Ho√†n t·∫•t!');

                        const interpretation = data.interpretation;
                        setAiInterpretation(interpretation);

                        // Cache k·∫øt qu·∫£
                        CacheManager.set(cacheKey, interpretation, 3600000); // 1 hour

                        setIsLoadingAI(false);
                        return; // Success, tho√°t kh·ªèi loop

                    } catch (error) {
                        console.error(`Attempt ${attempt} failed:`, error);
                        lastError = error.message;

                        if (attempt < maxRetries) {
                            const delay = Math.pow(2, attempt - 1) * 1000; // 1s, 2s, 4s
                            setLoadingStatus(`L·ªói, th·ª≠ l·∫°i sau ${delay/1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }

                // T·∫•t c·∫£ attempts failed
                setError(lastError || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                setIsLoadingAI(false);
                setLoadingProgress(0);
            };

            // ‚úÖ 8. DEBOUNCED VERSION
            const getAIInterpretationDebounced = useCallback(() => {
                if (debounceTimer.current) {
                    clearTimeout(debounceTimer.current);
                }

                debounceTimer.current = setTimeout(() => {
                    getAIInterpretation();
                }, 300);
            }, [hexagram]);

            const reset = () => {
                setDatetime('');
                setQuestion('');
                setQuestionError('');
                setHexagram(null);
                setAiInterpretation('');
                setError('');
                setIsCached(false);
            };

            const HexagramVisual = ({ lines, changingLine, isMain }) => (
                <div className="hexagram-visual" role="img" aria-label={`Qu·∫ª v·ªõi ${lines.filter(l => l === 1).length} h√†o d∆∞∆°ng`}>
                    {[...lines].reverse().map((line, index) => {
                        const actualPosition = 6 - index;
                        const isChanging = actualPosition === changingLine;
                        return (
                            <div 
                                key={index}
                                className={`hexagram-line ${line === 1 ? 'yang' : 'yin'} ${isChanging && isMain ? 'changing' : ''}`}
                                title={`H√†o ${actualPosition}: ${line === 1 ? 'D∆∞∆°ng' : '√Çm'}${isChanging && isMain ? ' - ƒê·ªòNG' : ''}`}
                                role="presentation"
                            />
                        );
                    })}
                </div>
            );

            const charCount = question.length;
            const charCountClass = charCount > 450 ? 'error' : charCount > 400 ? 'warning' : '';

            return (
                <div className="container">
                    <h1 className="sr-only">Kinh D·ªãch AI - ·ª®ng d·ª•ng lu·∫≠n gi·∫£i qu·∫ª</h1>
                    
                    <div className="header">
                        <div className="title" role="banner">ü™∑ Kinh D·ªãch AI ü™∑</div>
                        <p className="subtitle">
                            Lu·∫≠n Gi·∫£i Tr√≠ Tu·ªá 
                            <span className="success-badge">‚úÖ Improved</span>
                        </p>
                        <p className="description">64 Qu·∫ª ‚Ä¢ B·∫£o M·∫≠t ‚Ä¢ T·ªëi ∆Øu</p>
                    </div>

                    <div className="card">
                        <h2 className="card-header">üìø Th√¥ng Tin B·ªëc Qu·∫ª</h2>
                        
                        <div className="form-group">
                            <label className="label" htmlFor="datetime-input">‚è∞ Gi·ªù ƒê·ªông T√¢m</label>
                            <input
                                id="datetime-input"
                                type="datetime-local"
                                value={datetime}
                                onChange={(e) => setDatetime(e.target.value)}
                                className="input"
                                aria-required="true"
                            />
                            <p className="hint">Th·ªùi ƒëi·ªÉm ch√≠nh x√°c khi c√¢u h·ªèi xu·∫•t hi·ªán</p>
                        </div>

                        <div className="form-group">
                            <label className="label" htmlFor="question-input">
                                üí≠ C√¢u H·ªèi
                                <span className={`char-count ${charCountClass}`}>
                                    {charCount}/500
                                </span>
                            </label>
                            <textarea
                                id="question-input"
                                value={question}
                                onChange={handleQuestionChange}
                                placeholder="Tr√¨nh b√†y c√¢u h·ªèi c·ª• th·ªÉ (5-500 k√Ω t·ª±)..."
                                className={`textarea ${questionError ? 'error' : ''}`}
                                aria-required="true"
                                aria-invalid={!!questionError}
                                aria-describedby={questionError ? "question-error" : "question-hint"}
                            />
                            {questionError ? (
                                <p id="question-error" className="hint error-hint" role="alert">{questionError}</p>
                            ) : (
                                <p id="question-hint" className="hint">C√¢u h·ªèi chi ti·∫øt gi√∫p AI lu·∫≠n gi·∫£i ch√≠nh x√°c h∆°n</p>
                            )}
                        </div>

                        <div className="button-group">
                            <button
                                onClick={calculateHexagram}
                                disabled={isCalculating || !!questionError}
                                className="btn btn-primary"
                                aria-label="B·ªëc qu·∫ª"
                            >
                                {isCalculating ? <><span className="spinner" role="status"></span> ƒêang t√≠nh...</> : 'üîÆ B·ªëc Qu·∫ª'}
                            </button>
                            <button onClick={reset} className="btn btn-secondary" aria-label="L√†m l·∫°i t·ª´ ƒë·∫ßu">
                                üîÑ L√†m L·∫°i
                            </button>
                        </div>
                    </div>

                    {hexagram && (
                        <div className="fade-in">
                            <div className="card">
                                <h2 className="card-header">üéã Qu·∫ª T∆∞·ª£ng</h2>
                                
                                <div className="hexagram-grid">
                                    <div className="hexagram-card hexagram-main">
                                        <h3 className="hexagram-title" style={{color: '#dc2626'}}>üî¥ Qu·∫ª Ch√≠nh</h3>
                                        <HexagramVisual lines={hexagram.mainHex.lines} changingLine={hexagram.changingLine} isMain={true} />
                                        <p className="hexagram-name" style={{color: '#991b1b'}}>{hexagram.mainHex.name}</p>
                                        <p className="hexagram-number">Qu·∫ª {hexagram.mainHexNumber}/64</p>
                                        <p className="hexagram-meaning">{hexagram.mainHex.meaning}</p>
                                        <div className="hexagram-tags">
                                            <span className="tag" style={{color: '#dc2626'}}>{hexagram.mainHex.palace}</span>
                                            <span className="tag" style={{color: '#c2410c'}}>{hexagram.mainHex.element}</span>
                                        </div>
                                        <div className="extra-info">
                                            <div className="extra-info-title">üìä Chi Ti·∫øt:</div>
                                            <div>‚Ä¢ Th·∫ø: H√†o {hexagram.shiYao}</div>
                                            <div>‚Ä¢ ·ª®ng: H√†o {hexagram.yingYao}</div>
                                        </div>
                                    </div>

                                    <div className="hexagram-card hexagram-changed">
                                        <h3 className="hexagram-title" style={{color: '#3b82f6'}}>üîµ Qu·∫ª Bi·∫øn</h3>
                                        <HexagramVisual lines={hexagram.changedHex.lines} changingLine={null} isMain={false} />
                                        <p className="hexagram-name" style={{color: '#1e40af'}}>{hexagram.changedHex.name}</p>
                                        <p className="hexagram-number">Qu·∫ª {hexagram.changedHexNumber}/64</p>
                                        <p className="hexagram-meaning">{hexagram.changedHex.meaning}</p>
                                        <div className="hexagram-tags">
                                            <span className="tag" style={{color: '#3b82f6'}}>{hexagram.changedHex.palace}</span>
                                            <span className="tag" style={{color: '#6366f1'}}>{hexagram.changedHex.element}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="changing-line">‚ö° H√†o ƒê·ªông: H√†o {hexagram.changingLine}</div>

                                {isLoadingAI && (
                                    <div className="progress-container">
                                        <div className="progress-bar">
                                            <div className="progress-fill" style={{width: `${loadingProgress}%`}}></div>
                                        </div>
                                        <div className="progress-text">{loadingStatus}</div>
                                    </div>
                                )}

                                <button
                                    onClick={getAIInterpretationDebounced}
                                    disabled={isLoadingAI}
                                    className="btn btn-primary"
                                    style={{width: '100%', marginBottom: '1rem'}}
                                    aria-label="Nh·∫≠n l·ªùi gi·∫£i t·ª´ AI"
                                >
                                    {isLoadingAI ? (
                                        <><span className="spinner" role="status"></span> {loadingStatus}</>
                                    ) : (
                                        'ü§ñ Nh·∫≠n L·ªùi Gi·∫£i'
                                    )}
                                </button>

                                {error && (
                                    <div className="error-message" role="alert">
                                        <strong>‚ùå {error}</strong>
                                    </div>
                                )}
                            </div>

                            {aiInterpretation && (
                                <div className="card fade-in">
                                    <h2 className="card-header" style={{color: '#7c3aed'}}>
                                        üìú L·ªùi Gi·∫£i Chi Ti·∫øt
                                        {isCached && <span className="cache-badge">üì¶ T·ª´ cache</span>}
                                    </h2>
                                    <div className="interpretation" role="article">{aiInterpretation}</div>
                                    <div className="note">
                                        <p className="note-text">
                                            <strong>üí° L∆∞u √Ω:</strong> L·ªùi gi·∫£i ƒë∆∞·ª£c b·∫£o m·∫≠t qua backend. 
                                            K·∫øt h·ª£p v·ªõi th·ª±c t·∫ø ƒë·ªÉ quy·∫øt ƒë·ªãnh t·ªët nh·∫•t.
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<KinhDichApp />, document.getElementById('root'));
    </script>
</body>
</html>
