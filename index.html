<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinh Dá»‹ch AI - Supabase</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Giá»¯ nguyÃªn CSS nhÆ° cÅ© */
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Crimson Text', serif; background: linear-gradient(135deg, #fef5e7 0%, #fdeaa3 50%, #f8d7da 100%); padding: 20px; }
        #root { max-width: 1200px; margin: 0 auto; }
        .container { width: 100%; }
        .header { text-align: center; margin-bottom: 2rem; padding: 2rem 0; }
        .title { font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, #dc2626, #c2410c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-bar { display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; background: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .credits-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 0.5rem 1rem; border-radius: 1.5rem; font-weight: 700; color: #78350f; border: 2px solid #f59e0b; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 1rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.3s; font-size: 1rem; }
        .btn-primary { background: linear-gradient(135deg, #dc2626, #f59e0b); color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-large { padding: 1.5rem; font-size: 1.25rem; width: 100%; }
        .card { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 25px 60px rgba(185, 28, 28, 0.2); border: 5px solid; border-image: linear-gradient(135deg, #dc2626, #f59e0b) 1; margin-bottom: 2rem; }
        .card-header { font-size: 1.75rem; font-weight: 700; color: #7f1d1d; text-align: center; border-bottom: 3px solid #fecaca; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .label { display: block; font-size: 1.1rem; font-weight: 700; color: #991b1b; margin-bottom: 0.5rem; }
        .input, .textarea { width: 100%; padding: 1rem; border: 3px solid #fecaca; border-radius: 1rem; font-size: 1rem; font-family: 'Crimson Text', serif; }
        .textarea { min-height: 140px; resize: vertical; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 1.5rem; padding: 2.5rem; max-width: 450px; width: 90%; }
        .modal-title { font-size: 2rem; font-weight: 700; color: #7f1d1d; margin-bottom: 1.5rem; text-align: center; }
        .hexagram-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 2rem 0; }
        .hexagram-card { padding: 1.5rem; border-radius: 1.5rem; border: 4px solid; text-align: center; }
        .hexagram-main { background: linear-gradient(135deg, #fef2f2, #fed7aa); border-color: #dc2626; }
        .hexagram-changed { background: linear-gradient(135deg, #eff6ff, #e0e7ff); border-color: #3b82f6; }
        .hexagram-visual { margin: 1.5rem 0; display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }
        .hexagram-line { width: 80%; height: 12px; border-radius: 6px; }
        .hexagram-line.yang { background: linear-gradient(90deg, #dc2626, #991b1b); }
        .hexagram-line.yin { display: flex; gap: 8%; }
        .hexagram-line.yin::before, .hexagram-line.yin::after { content: ''; flex: 1; background: linear-gradient(90deg, #1e40af, #1e3a8a); border-radius: 6px; }
        .hexagram-name { font-size: 1.5rem; font-weight: 700; margin: 1rem 0; }
        .interpretation { padding: 1.5rem; background: #faf5ff; border-left: 6px solid #7c3aed; border-radius: 1rem; margin-top: 2rem; font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap; }
        .spinner { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .error { color: #dc2626; font-size: 0.9rem; margin-top: 0.5rem; }
        .success { color: #059669; font-size: 0.9rem; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = window.supabase;

        // =============================================
        // ğŸ”´ğŸ”´ğŸ”´ THAY URL VÃ€ KEY THáº¬T Cá»¦A Báº N VÃ€O ÄÃ‚Y ğŸ”´ğŸ”´ğŸ”´
        // =============================================
        const supabaseUrl = "https://qqadeyowwdslkkuesdxg.supabase.co";  // THAY URL THáº¬T
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxYWRleW93d2RzbGtrdWVzZHhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjQ4NTUsImV4cCI6MjA4NjE0MDg1NX0.2oa-3MO-IkITrrgtXY3PWBPrFw8y7C2b6zTO7HAR_zE";                // THAY KEY THáº¬T
        
        // KHá»I Táº O SUPABASE CLIENT
        let supabase;
        try {
            if (!supabaseUrl.includes('your-project') && !supabaseAnonKey.includes('your-anon')) {
                supabase = createClient(supabaseUrl, supabaseAnonKey);
                console.log('âœ… Supabase connected!');
            } else {
                console.error('âŒ Báº¡n chÆ°a thay URL vÃ  Key tháº­t!');
                supabase = null;
            }
        } catch (e) {
            console.error('âŒ Lá»—i khá»Ÿi táº¡o Supabase:', e);
            supabase = null;
        }

        // Dá»¯ liá»‡u 64 quáº» Kinh Dá»‹ch (giá»¯ nguyÃªn nhÆ° cÅ©)
        const hexagrams = {
            1: { name: 'CÃ n Vi ThiÃªn', meaning: 'Thuáº§n DÆ°Æ¡ng - Trá»i', element: 'Kim', palace: 'CÃ n', shiYao: 4 },
            2: { name: 'KhÃ´n Vi Äá»‹a', meaning: 'Thuáº§n Ã‚m - Äáº¥t', element: 'Thá»•', palace: 'KhÃ´n', shiYao: 1 },
            // ... (thÃªm Ä‘á»§ 64 quáº» nhÆ° code cÅ©)
            64: { name: 'Há»a Thá»§y Vá»‹ Táº¿', meaning: 'ChÆ°a hoÃ n thÃ nh', element: 'Há»a', palace: 'Ly', shiYao: 6 }
        };

        // ThÃªm dá»¯ liá»‡u Ä‘áº§y Ä‘á»§ 64 quáº» (copy tá»« code cÅ©)
        // ... (tÃ´i Ä‘ang viáº¿t táº¯t, báº¡n copy pháº§n hexagrams Ä‘áº§y Ä‘á»§ tá»« code trÆ°á»›c)

        const hexagramTable = [
            [1,34,5,26,11,9,14,43],
            [25,51,3,27,24,42,21,17],
            [6,40,29,4,7,59,64,47],
            [33,62,39,52,15,53,56,31],
            [12,16,8,23,2,20,35,45],
            [44,32,48,18,46,57,50,28],
            [13,55,63,22,36,37,30,49],
            [10,54,60,41,19,61,38,58]
        ];

        const getHexagramLines = (num) => {
            // Copy hÃ m nÃ y tá»« code cÅ©
            const lines = { /* ... */ };
            return lines[num] || [1,1,1,1,1,1];
        };

        function KinhDichApp() {
            const [user, setUser] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [authError, setAuthError] = useState('');
            const [authSuccess, setAuthSuccess] = useState('');
            const [profile, setProfile] = useState(null);
            const [datetime, setDatetime] = useState('');
            const [question, setQuestion] = useState('');
            const [hexagram, setHexagram] = useState(null);
            const [isCalculating, setIsCalculating] = useState(false);
            const [aiInterpretation, setAiInterpretation] = useState('');
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [error, setError] = useState('');
            const [supabaseError, setSupabaseError] = useState(
                !supabase ? 'âš ï¸ Báº¡n chÆ°a cáº¥u hÃ¬nh Supabase! VÃ o code sá»­a supabaseUrl vÃ  supabaseAnonKey' : ''
            );

            useEffect(() => {
                if (supabase) {
                    checkUser();
                }
            }, []);

            const checkUser = async () => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session?.user) {
                        setUser(session.user);
                        await fetchProfile(session.user.id);
                    }
                } catch (error) {
                    console.error('Lá»—i checkUser:', error);
                }
            };

            const fetchProfile = async (userId) => {
                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();
                    if (data) setProfile(data);
                } catch (error) {
                    console.error('Lá»—i fetchProfile:', error);
                }
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                if (!supabase) {
                    setAuthError('Supabase chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!');
                    return;
                }
                setAuthError('');
                setAuthSuccess('');
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { full_name: fullName } }
                });
                if (error) setAuthError(error.message);
                else {
                    setAuthSuccess('âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng kiá»ƒm tra email.');
                    setTimeout(() => { setShowAuth(false); setIsLogin(true); }, 2000);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!supabase) {
                    setAuthError('Supabase chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!');
                    return;
                }
                setAuthError('');
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) setAuthError(error.message);
                else {
                    setUser(data.user);
                    await fetchProfile(data.user.id);
                    setShowAuth(false);
                }
            };

            const handleLogout = async () => {
                if (!supabase) return;
                await supabase.auth.signOut();
                setUser(null);
                setProfile(null);
                setHexagram(null);
                setAiInterpretation('');
            };

            const calculateHexagram = () => {
                if (!datetime || !question) { 
                    alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§!'); 
                    return; 
                }
                setIsCalculating(true);
                
                setTimeout(() => {
                    const date = new Date(datetime);
                    const y = date.getFullYear(), m = date.getMonth()+1, d = date.getDate(), h = date.getHours(), min = date.getMinutes();
                    const upper = ((y+m+d)%8)||8, lower = ((y+m+d+h)%8)||8, changing = ((y+m+d+h+min)%6)||6;
                    const mainHexNum = hexagramTable[upper-1][lower-1];
                    const mainLines = getHexagramLines(mainHexNum);
                    const changedLines = [...mainLines];
                    changedLines[changing-1] = 1-changedLines[changing-1];
                    
                    let changedHexNum = mainHexNum;
                    for(let i=1;i<=64;i++){
                        if(JSON.stringify(getHexagramLines(i))===JSON.stringify(changedLines)){
                            changedHexNum=i;
                            break;
                        }
                    }
                    
                    const mainHex = hexagrams[mainHexNum];
                    const changedHex = hexagrams[changedHexNum];
                    
                    setHexagram({
                        mainHex: {...mainHex, lines: mainLines},
                        mainHexNum,
                        changedHex: {...changedHex, lines: changedLines},
                        changedHexNum,
                        changingLine: changing,
                        datetime: date.toLocaleString('vi-VN'),
                        question
                    });
                    
                    setIsCalculating(false);
                }, 800);
            };

            const getAIInterpretation = async () => {
                if(!user){
                    alert('âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p!');
                    setShowAuth(true);
                    return;
                }
                if(profile?.credits_remaining <= 0){
                    alert('âš ï¸ Báº¡n Ä‘Ã£ háº¿t lÆ°á»£t bá»‘c quáº» miá»…n phÃ­!');
                    return;
                }
                
                setIsLoadingAI(true);
                setError('');
                
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        alert('PhiÃªn háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
                        return;
                    }

                    // Gá»i API AI - Báº N Cáº¦N Táº O SERVER
                    const response = await fetch('/api/interpret', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            question: hexagram.question,
                            datetime: hexagram.datetime,
                            mainHexName: hexagram.mainHex.name,
                            mainHexNumber: hexagram.mainHexNum,
                            changedHexName: hexagram.changedHex.name,
                            changedHexNumber: hexagram.changedHexNum,
                            changingLine: hexagram.changingLine
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        setError(data.error || 'Lá»—i tá»« server');
                        return;
                    }
                    
                    setAiInterpretation(data.interpretation);
                    await fetchProfile(user.id); // Cáº­p nháº­t credits
                    
                } catch (e) {
                    setError('âŒ Lá»—i: ' + e.message);
                    console.error(e);
                } finally {
                    setIsLoadingAI(false);
                }
            };

            const HexagramVisual = ({ lines }) => (
                <div className="hexagram-visual">
                    {[...lines].reverse().map((line, i) => (
                        <div key={i} className={`hexagram-line ${line === 1 ? 'yang' : 'yin'}`} />
                    ))}
                </div>
            );

            return (
                <div className="container">
                    {/* Hiá»ƒn thá»‹ lá»—i náº¿u chÆ°a cáº¥u hÃ¬nh Supabase */}
                    {supabaseError && (
                        <div style={{ 
                            background: '#fee2e2', 
                            border: '2px solid #dc2626',
                            padding: '1rem', 
                            borderRadius: '1rem',
                            marginBottom: '1rem',
                            color: '#991b1b'
                        }}>
                            <strong>ğŸ”´ {supabaseError}</strong><br/>
                            <small>VÃ o code tÃ¬m dÃ²ng "your-project" vÃ  "your-anon-key" Ä‘á»ƒ thay tháº¿.</small>
                        </div>
                    )}

                    {/* Thanh Ä‘Äƒng nháº­p */}
                    <div className="auth-bar">
                        {user ? (
                            <div className="user-info">
                                <span>ğŸ‘¤ {profile?.email || user.email}</span>
                                <span className="credits-badge">âš¡ CÃ²n {profile?.credits_remaining || 0} láº§n</span>
                                <button onClick={handleLogout} className="btn btn-secondary">
                                    ÄÄƒng xuáº¥t
                                </button>
                            </div>
                        ) : (
                            <button onClick={() => setShowAuth(true)} className="btn btn-primary">
                                ğŸ”‘ ÄÄƒng nháº­p
                            </button>
                        )}
                    </div>

                    {/* Header */}
                    <div className="header">
                        <div className="title">ğŸª· Kinh Dá»‹ch AI ğŸª·</div>
                        <div style={{ fontSize: '1.3rem', color: '#7f1d1d' }}>
                            {supabase ? 'âœ… Supabase Connected' : 'âŒ Cáº§n cáº¥u hÃ¬nh Supabase'}
                        </div>
                    </div>

                    {/* Modal Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½ */}
                    {showAuth && (
                        <div className="modal-overlay" onClick={() => setShowAuth(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-title">
                                    {isLogin ? 'ğŸ” ÄÄƒng nháº­p' : 'ğŸ“ ÄÄƒng kÃ½'}
                                </div>
                                <form onSubmit={isLogin ? handleLogin : handleSignup}>
                                    {!isLogin && (
                                        <div className="form-group">
                                            <label className="label">Há» tÃªn</label>
                                            <input 
                                                className="input" 
                                                value={fullName} 
                                                onChange={e => setFullName(e.target.value)} 
                                                required 
                                            />
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label className="label">Email</label>
                                        <input 
                                            type="email" 
                                            className="input" 
                                            value={email} 
                                            onChange={e => setEmail(e.target.value)} 
                                            required 
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="label">Máº­t kháº©u</label>
                                        <input 
                                            type="password" 
                                            className="input" 
                                            value={password} 
                                            onChange={e => setPassword(e.target.value)} 
                                            required 
                                        />
                                    </div>
                                    {authError && <div className="error">{authError}</div>}
                                    {authSuccess && <div className="success">{authSuccess}</div>}
                                    
                                    <button type="submit" className="btn btn-primary btn-large">
                                        {isLogin ? 'ÄÄƒng nháº­p' : 'ÄÄƒng kÃ½'}
                                    </button>
                                    
                                    <div style={{ textAlign: 'center', marginTop: '1rem' }}>
                                        <a 
                                            href="#" 
                                            onClick={e => {
                                                e.preventDefault();
                                                setIsLogin(!isLogin);
                                                setAuthError('');
                                                setAuthSuccess('');
                                            }}
                                        >
                                            {isLogin ? 'ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½' : 'ÄÃ£ cÃ³ tÃ i khoáº£n? ÄÄƒng nháº­p'}
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Form bá»‘c quáº» */}
                    <div className="card">
                        <div className="card-header">ğŸ“¿ Bá»C QUáºº</div>
                        
                        <div className="form-group">
                            <label className="label">â° Giá» Ä‘á»™ng tÃ¢m</label>
                            <input 
                                type="datetime-local" 
                                className="input" 
                                value={datetime} 
                                onChange={e => setDatetime(e.target.value)}
                            />
                        </div>

                        <div className="form-group">
                            <label className="label">ğŸ’­ CÃ¢u há»i</label>
                            <textarea 
                                className="textarea" 
                                value={question} 
                                onChange={e => setQuestion(e.target.value)}
                                placeholder="Nháº­p cÃ¢u há»i cá»§a báº¡n..."
                            />
                        </div>

                        <button 
                            onClick={calculateHexagram} 
                            disabled={isCalculating}
                            className="btn btn-primary btn-large"
                        >
                            {isCalculating ? (
                                <><span className="spinner" /> Äang tÃ­nh quáº»...</>
                            ) : 'ğŸ”® Bá»C QUáºº'}
                        </button>
                    </div>

                    {/* Hiá»ƒn thá»‹ quáº» */}
                    {hexagram && (
                        <div className="fade-in">
                            <div className="card">
                                <div className="card-header">ğŸ‹ Káº¾T QUáº¢</div>
                                
                                <div style={{ background: '#fef2f2', padding: '1rem', borderRadius: '1rem', marginBottom: '1rem' }}>
                                    <strong>â± Giá»:</strong> {hexagram.datetime}<br />
                                    <strong>ğŸ’­ Há»i:</strong> {hexagram.question}
                                </div>

                                <div className="hexagram-grid">
                                    <div className="hexagram-card hexagram-main">
                                        <h3 style={{ color: '#dc2626' }}>ğŸ”´ QUáºº CHÃNH</h3>
                                        <HexagramVisual lines={hexagram.mainHex.lines} />
                                        <div className="hexagram-name" style={{ color: '#991b1b' }}>
                                            {hexagram.mainHex.name}
                                        </div>
                                        <div>
                                            {hexagram.mainHex.meaning}<br/>
                                            HÃ o Ä‘á»™ng: {hexagram.changingLine}
                                        </div>
                                    </div>

                                    <div className="hexagram-card hexagram-changed">
                                        <h3 style={{ color: '#3b82f6' }}>ğŸ”µ QUáºº BIáº¾N</h3>
                                        <HexagramVisual lines={hexagram.changedHex.lines} />
                                        <div className="hexagram-name" style={{ color: '#1e40af' }}>
                                            {hexagram.changedHex.name}
                                        </div>
                                        <div>
                                            {hexagram.changedHex.meaning}
                                        </div>
                                    </div>
                                </div>

                                {/* NÃºt AI - CHá»ˆ KHI CÃ“ USER */}
                                {user ? (
                                    <button 
                                        onClick={getAIInterpretation} 
                                        disabled={isLoadingAI || profile?.credits_remaining <= 0}
                                        className="btn btn-primary btn-large"
                                        style={{ marginTop: '1rem' }}
                                    >
                                        {isLoadingAI ? (
                                            <><span className="spinner" /> Äang luáº­n giáº£i...</>
                                        ) : profile?.credits_remaining <= 0 ? (
                                            'â›” Háº¿t lÆ°á»£t sá»­ dá»¥ng'
                                        ) : (
                                            'ğŸ¤– LUáº¬N GIáº¢I AI'
                                        )}
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => setShowAuth(true)}
                                        className="btn btn-secondary btn-large"
                                        style={{ marginTop: '1rem' }}
                                    >
                                        ğŸ”‘ ÄÄƒng nháº­p Ä‘á»ƒ dÃ¹ng AI
                                    </button>
                                )}

                                {error && <div className="error" style={{ marginTop: '1rem' }}>{error}</div>}
                                
                                {aiInterpretation && (
                                    <div className="interpretation">
                                        {aiInterpretation}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render app
        ReactDOM.render(<KinhDichApp />, document.getElementById('root'));
    </script>
</body>
</html>
