<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinh D·ªãch AI - Authenticated</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Crimson Text', serif; background: linear-gradient(135deg, #fef5e7 0%, #fdeaa3 50%, #f8d7da 100%); background-attachment: fixed; min-height: 100vh; }
        .lotus-bg { background-image: radial-gradient(circle at 20% 30%, rgba(219, 39, 119, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(167, 139, 250, 0.03) 0%, transparent 50%), url("data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M60 15 C45 15 45 30 60 45 C75 30 75 15 60 15 M60 105 C45 105 45 90 60 75 C75 90 75 105 60 105 M15 60 C15 45 30 45 45 60 C30 75 15 75 15 60 M105 60 C105 45 90 45 75 60 C90 75 105 75 105 60' fill='none' stroke='%23dc2626' stroke-width='0.5' opacity='0.15'/%3E%3C/svg%3E"); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { text-align: center; margin-bottom: 2rem; padding: 2rem 0; position: relative; }
        .title { font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, #dc2626, #c2410c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
        .subtitle { font-size: 1.3rem; color: #7f1d1d; font-weight: 600; }
        
        /* Auth UI */
        .auth-bar { display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; background: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .credits-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 0.5rem 1rem; border-radius: 1.5rem; font-weight: 700; color: #78350f; border: 2px solid #f59e0b; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 1rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.3s; font-size: 1rem; }
        .btn-primary { background: linear-gradient(135deg, #dc2626, #f59e0b); color: white; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 1.5rem; padding: 2.5rem; max-width: 450px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .modal-title { font-size: 2rem; font-weight: 700; color: #7f1d1d; margin-bottom: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 1.5rem; }
        .label { display: block; font-size: 1.1rem; font-weight: 700; color: #991b1b; margin-bottom: 0.5rem; }
        .input { width: 100%; padding: 1rem; border: 3px solid #fecaca; border-radius: 1rem; font-size: 1rem; font-family: 'Crimson Text', serif; }
        .input:focus { outline: none; border-color: #dc2626; }
        .error { color: #dc2626; font-size: 0.9rem; margin-top: 0.5rem; }
        .success { color: #059669; font-size: 0.9rem; margin-top: 0.5rem; }
        
        /* Card */
        .card { background: white; border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 25px 60px rgba(185, 28, 28, 0.2); border: 5px solid; border-image: linear-gradient(135deg, #dc2626, #f59e0b, #dc2626) 1; margin-bottom: 2rem; }
        .card-header { font-size: 1.75rem; font-weight: 700; color: #7f1d1d; margin-bottom: 1.5rem; text-align: center; border-bottom: 3px solid #fecaca; padding-bottom: 1rem; }
        .textarea { width: 100%; padding: 1.25rem; border: 3px solid #fecaca; border-radius: 1rem; font-size: 1.1rem; font-family: 'Crimson Text', serif; min-height: 140px; resize: vertical; }
        .button-group { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .btn-large { flex: 1; padding: 1.5rem; font-size: 1.25rem; border-radius: 1rem; }
        
        /* Hexagram Display */
        .hexagram-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin: 2rem 0; }
        .hexagram-card { padding: 2rem; border-radius: 1.5rem; border: 4px solid; text-align: center; }
        .hexagram-main { background: linear-gradient(135deg, #fef2f2, #fed7aa); border-color: #dc2626; }
        .hexagram-changed { background: linear-gradient(135deg, #eff6ff, #e0e7ff); border-color: #3b82f6; }
        .hexagram-visual { margin: 1.5rem 0; display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }
        .hexagram-line { width: 80%; height: 12px; border-radius: 6px; }
        .hexagram-line.yang { background: linear-gradient(90deg, #dc2626, #991b1b); }
        .hexagram-line.yin { display: flex; gap: 8%; }
        .hexagram-line.yin::before, .hexagram-line.yin::after { content: ''; flex: 1; background: linear-gradient(90deg, #1e40af, #1e3a8a); border-radius: 6px; }
        .hexagram-name { font-size: 2rem; font-weight: 700; margin: 1rem 0; }
        .interpretation { padding: 2.5rem; background: linear-gradient(135deg, #faf5ff, #f3e8ff); border-radius: 1.5rem; border-left: 6px solid #7c3aed; font-size: 1.2rem; line-height: 2; white-space: pre-wrap; margin-top: 2rem; }
        .spinner { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .note { margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 1.5rem; border: 3px solid #f59e0b; color: #78350f; }
    </style>
</head>
<body class="lotus-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supabase client
        const supabase = window.supabase.createClient(
            ' https://qqadeyowwdslkkuesdxg.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxYWRleW93d2RzbGtrdWVzZHhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjQ4NTUsImV4cCI6MjA4NjE0MDg1NX0.2oa-3MO-IkITrrgtXY3PWBPrFw8y7C2b6zTO7HAR_zE'
        );

        const hexagrams = {
            1: { name: 'C√†n Vi Thi√™n', meaning: 'Qu·∫ª thu·∫ßn D∆∞∆°ng', element: 'Kim', palace: 'C√†n', shiYao: 4 },
            2: { name: 'Kh√¥n Vi ƒê·ªãa', meaning: 'Qu·∫ª thu·∫ßn √Çm', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 1 },
            3: { name: 'Th·ªßy L√¥i Tru√¢n', meaning: 'Kh√≥ khƒÉn ban ƒë·∫ßu', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 2 },
            4: { name: 'S∆°n Th·ªßy M√¥ng', meaning: 'Tr·∫ª th∆° m·ªù m·ªãt', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
            5: { name: 'Th·ªßy Thi√™n Nhu', meaning: 'Ch·ªù ƒë·ª£i th·ªùi c∆°', element: 'Th·ªßy', palace: 'C√†n', shiYao: 5 },
            6: { name: 'Thi√™n Th·ªßy T·ª•ng', meaning: 'Tranh t·ª•ng', element: 'Kim', palace: 'C√†n', shiYao: 5 },
            7: { name: 'ƒê·ªãa Th·ªßy S∆∞', meaning: 'ƒê·ªôi qu√¢n', element: 'Th·ªßy', palace: 'Kh√¥n', shiYao: 2 },
            8: { name: 'Th·ªßy ƒê·ªãa T·ª∑', meaning: 'Th√¢n c·∫≠n', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 5 },
            9: { name: 'Phong Thi√™n Ti·ªÉu S√∫c', meaning: 'S√∫c d∆∞·ª°ng nh·ªè', element: 'M·ªôc', palace: 'C√†n', shiYao: 4 },
            10: { name: 'Thi√™n Tr·∫°ch L√Ω', meaning: 'Gi·∫´m ƒëu√¥i h·ªï', element: 'Kim', palace: 'C√†n', shiYao: 3 },
            11: { name: 'ƒê·ªãa Thi√™n Th√°i', meaning: 'Th√¥ng su·ªët', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 3 },
            12: { name: 'Thi√™n ƒê·ªãa Bƒ©', meaning: 'T·∫Øc ngh·∫Ωn', element: 'Th·ªï', palace: 'C√†n', shiYao: 3 },
            13: { name: 'Thi√™n H·ªèa ƒê·ªìng Nh√¢n', meaning: 'ƒêo√†n k·∫øt', element: 'H·ªèa', palace: 'C√†n', shiYao: 5 },
            14: { name: 'H·ªèa Thi√™n ƒê·∫°i H·ªØu', meaning: 'S·ªü h·ªØu l·ªõn', element: 'Kim', palace: 'Ly', shiYao: 2 },
            15: { name: 'ƒê·ªãa S∆°n Khi√™m', meaning: 'Khi√™m t·ªën', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 4 },
            16: { name: 'L√¥i ƒê·ªãa D·ª±', meaning: 'Vui v·∫ª', element: 'Th·ªï', palace: 'Ch·∫•n', shiYao: 1 },
            17: { name: 'Tr·∫°ch L√¥i T√πy', meaning: 'Theo ƒëu·ªïi', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 4 },
            18: { name: 'S∆°n Phong C·ªï', meaning: 'S·ª≠a ch·ªØa', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 5 },
            19: { name: 'ƒê·ªãa Tr·∫°ch L√¢m', meaning: 'Ti·∫øp c·∫≠n', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 5 },
            20: { name: 'Phong ƒê·ªãa Quan', meaning: 'Quan s√°t', element: 'Th·ªï', palace: 'T·ªën', shiYao: 2 },
            21: { name: 'H·ªèa L√¥i Ph·ªá H·∫°p', meaning: 'C·∫Øn ƒë·ª©t', element: 'H·ªèa', palace: 'Ch·∫•n', shiYao: 4 },
            22: { name: 'S∆°n H·ªèa B√≠', meaning: 'Trang tr√≠', element: 'H·ªèa', palace: 'Ly', shiYao: 3 },
            23: { name: 'S∆°n ƒê·ªãa B√°c', meaning: 'B√≥c tr√≥c', element: 'Th·ªï', palace: 'Kh√¥n', shiYao: 6 },
            24: { name: 'ƒê·ªãa L√¥i Ph·ª•c', meaning: 'Ph·ª•c h·ªìi', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 4 },
            25: { name: 'Thi√™n L√¥i V√¥ V·ªçng', meaning: 'Kh√¥ng v·ªçng ƒë·ªông', element: 'Kim', palace: 'C√†n', shiYao: 6 },
            26: { name: 'S∆°n Thi√™n ƒê·∫°i S√∫c', meaning: 'S√∫c d∆∞·ª°ng l·ªõn', element: 'Kim', palace: 'C√†n', shiYao: 6 },
            27: { name: 'S∆°n L√¥i Di', meaning: 'Nu√¥i d∆∞·ª°ng', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 1 },
            28: { name: 'Tr·∫°ch Phong ƒê·∫°i Qu√°', meaning: 'Qu√° m·ª©c', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 5 },
            29: { name: 'Kh·∫£m Vi Th·ªßy', meaning: 'Thu·∫ßn Th·ªßy', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 2 },
            30: { name: 'Ly Vi H·ªèa', meaning: 'Thu·∫ßn H·ªèa', element: 'H·ªèa', palace: 'Ly', shiYao: 5 },
            31: { name: 'Tr·∫°ch S∆°n H√†m', meaning: 'C·∫£m ·ª©ng', element: 'Kim', palace: 'ƒêo√†i', shiYao: 3 },
            32: { name: 'L√¥i Phong H·∫±ng', meaning: 'B·ªÅn l√¢u', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 5 },
            33: { name: 'Thi√™n S∆°n ƒê·ªôn', meaning: 'R√∫t lui', element: 'Kim', palace: 'C√†n', shiYao: 3 },
            34: { name: 'L√¥i Thi√™n ƒê·∫°i Tr√°ng', meaning: 'M·∫°nh l·ªõn', element: 'Kim', palace: 'Ch·∫•n', shiYao: 4 },
            35: { name: 'H·ªèa ƒê·ªãa T·∫•n', meaning: 'Ti·∫øn l√™n', element: 'H·ªèa', palace: 'Ly', shiYao: 1 },
            36: { name: 'ƒê·ªãa H·ªèa Minh Di', meaning: '√Ånh s√°ng t·ªïn', element: 'H·ªèa', palace: 'Kh√¥n', shiYao: 2 },
            37: { name: 'Phong H·ªèa Gia Nh√¢n', meaning: 'Gia ƒë√¨nh', element: 'H·ªèa', palace: 'Ly', shiYao: 3 },
            38: { name: 'H·ªèa Tr·∫°ch Qu·ªµ', meaning: 'Tr√°i ng∆∞·ª£c', element: 'H·ªèa', palace: 'ƒêo√†i', shiYao: 6 },
            39: { name: 'Th·ªßy S∆°n Ki·ªÉn', meaning: 'Kh√≥ khƒÉn', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
            40: { name: 'L√¥i Th·ªßy Gi·∫£i', meaning: 'Gi·∫£i tho√°t', element: 'Th·ªßy', palace: 'Ch·∫•n', shiYao: 2 },
            41: { name: 'S∆°n Tr·∫°ch T·ªïn', meaning: 'Gi·∫£m b·ªõt', element: 'Kim', palace: 'ƒêo√†i', shiYao: 2 },
            42: { name: 'Phong L√¥i √çch', meaning: 'TƒÉng √≠ch', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 1 },
            43: { name: 'Tr·∫°ch Thi√™n Qu·∫£i', meaning: 'Quy·∫øt ƒëo√°n', element: 'Kim', palace: 'C√†n', shiYao: 4 },
            44: { name: 'Thi√™n Phong C·∫•u', meaning: 'G·∫∑p g·ª°', element: 'M·ªôc', palace: 'T·ªën', shiYao: 1 },
            45: { name: 'Tr·∫°ch ƒê·ªãa T·ª•y', meaning: 'T·ª• h·ªçp', element: 'Th·ªï', palace: 'ƒêo√†i', shiYao: 3 },
            46: { name: 'ƒê·ªãa Phong ThƒÉng', meaning: 'ThƒÉng ti·∫øn', element: 'M·ªôc', palace: 'T·ªën', shiYao: 2 },
            47: { name: 'Tr·∫°ch Th·ªßy Kh·ªën', meaning: 'C√πng qu·∫´n', element: 'Th·ªßy', palace: 'ƒêo√†i', shiYao: 5 },
            48: { name: 'Th·ªßy Phong T·ªânh', meaning: 'Gi·∫øng n∆∞·ªõc', element: 'M·ªôc', palace: 'Kh·∫£m', shiYao: 4 },
            49: { name: 'Tr·∫°ch H·ªèa C√°ch', meaning: 'C√°ch m·∫°ng', element: 'H·ªèa', palace: 'Ly', shiYao: 5 },
            50: { name: 'H·ªèa Phong ƒê·ªânh', meaning: 'ƒê·ªânh n·∫•u', element: 'M·ªôc', palace: 'Ly', shiYao: 4 },
            51: { name: 'Ch·∫•n Vi L√¥i', meaning: 'Thu·∫ßn L√¥i', element: 'M·ªôc', palace: 'Ch·∫•n', shiYao: 3 },
            52: { name: 'C·∫•n Vi S∆°n', meaning: 'Thu·∫ßn S∆°n', element: 'Th·ªï', palace: 'C·∫•n', shiYao: 6 },
            53: { name: 'Phong S∆°n Ti·ªám', meaning: 'Ti·∫øn d·∫ßn', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 5 },
            54: { name: 'L√¥i Tr·∫°ch Quy Mu·ªôi', meaning: 'Con g√°i v·ªÅ', element: 'Kim', palace: 'Ch·∫•n', shiYao: 6 },
            55: { name: 'L√¥i H·ªèa Phong', meaning: 'Phong ph√∫', element: 'H·ªèa', palace: 'Ch·∫•n', shiYao: 4 },
            56: { name: 'H·ªèa S∆°n L·ªØ', meaning: 'Kh√°ch l·ªØ', element: 'H·ªèa', palace: 'C·∫•n', shiYao: 4 },
            57: { name: 'T·ªën Vi Phong', meaning: 'Thu·∫ßn Phong', element: 'M·ªôc', palace: 'T·ªën', shiYao: 1 },
            58: { name: 'ƒêo√†i Vi Tr·∫°ch', meaning: 'Thu·∫ßn Tr·∫°ch', element: 'Kim', palace: 'ƒêo√†i', shiYao: 4 },
            59: { name: 'Phong Th·ªßy Ho√°n', meaning: 'Ph√¢n t√°n', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 6 },
            60: { name: 'Th·ªßy Tr·∫°ch Ti·∫øt', meaning: 'Ti·∫øt ƒë·ªô', element: 'Th·ªßy', palace: 'ƒêo√†i', shiYao: 2 },
            61: { name: 'Phong Tr·∫°ch Trung Phu', meaning: 'Trung t√≠n', element: 'M·ªôc', palace: 'ƒêo√†i', shiYao: 3 },
            62: { name: 'L√¥i S∆°n Ti·ªÉu Qu√°', meaning: 'V∆∞·ª£t nh·ªè', element: 'M·ªôc', palace: 'C·∫•n', shiYao: 6 },
            63: { name: 'Th·ªßy H·ªèa K√Ω T·∫ø', meaning: 'ƒê√£ ho√†n th√†nh', element: 'Th·ªßy', palace: 'Kh·∫£m', shiYao: 3 },
            64: { name: 'H·ªèa Th·ªßy V·ªã T·∫ø', meaning: 'Ch∆∞a ho√†n th√†nh', element: 'H·ªèa', palace: 'Ly', shiYao: 6 }
        };

        const hexagramTable = [
            [1,34,5,26,11,9,14,43],[25,51,3,27,24,42,21,17],
            [6,40,29,4,7,59,64,47],[33,62,39,52,15,53,56,31],
            [12,16,8,23,2,20,35,45],[44,32,48,18,46,57,50,28],
            [13,55,63,22,36,37,30,49],[10,54,60,41,19,61,38,58]
        ];

        function KinhDichApp() {
            const [user, setUser] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [authError, setAuthError] = useState('');
            const [authSuccess, setAuthSuccess] = useState('');
            const [profile, setProfile] = useState(null);
            const [datetime, setDatetime] = useState('');
            const [question, setQuestion] = useState('');
            const [hexagram, setHexagram] = useState(null);
            const [isCalculating, setIsCalculating] = useState(false);
            const [aiInterpretation, setAiInterpretation] = useState('');
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                checkUser();
            }, []);

            const checkUser = async () => {
                const { data: { session } } = await supabase.auth.getSession();
                if (session?.user) {
                    setUser(session.user);
                    await fetchProfile(session.user.id);
                }
            };

            const fetchProfile = async (userId) => {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                if (data) setProfile(data);
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setAuthError('');
                setAuthSuccess('');
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: { data: { full_name: fullName } }
                });
                if (error) setAuthError(error.message);
                else {
                    setAuthSuccess('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email.');
                    setTimeout(() => { setShowAuth(false); setIsLogin(true); }, 2000);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError('');
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) setAuthError(error.message);
                else {
                    setUser(data.user);
                    await fetchProfile(data.user.id);
                    setShowAuth(false);
                }
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUser(null);
                setProfile(null);
                setHexagram(null);
                setAiInterpretation('');
            };

            const getHexagramLines = (hexNumber) => {
                const hexBinary = {1:[1,1,1,1,1,1],2:[0,0,0,0,0,0],3:[1,0,0,0,1,0],4:[0,1,0,0,0,1],5:[0,1,0,1,1,1],6:[1,1,1,0,1,0],7:[0,1,0,0,0,0],8:[0,0,0,0,1,0],9:[0,1,1,1,1,1],10:[1,1,1,0,1,1],11:[1,1,1,0,0,0],12:[0,0,0,1,1,1],13:[1,0,1,1,1,1],14:[1,1,1,1,0,1],15:[0,0,1,0,0,0],16:[0,0,0,1,0,0],17:[1,0,0,0,0,1],18:[1,0,0,1,1,0],19:[0,0,0,0,1,1],20:[1,1,0,0,0,0],21:[1,0,1,0,0,1],22:[1,0,0,1,0,1],23:[1,0,0,0,0,0],24:[0,0,0,0,0,1],25:[1,0,0,1,1,1],26:[1,1,1,0,0,1],27:[1,0,0,0,0,1],28:[0,1,1,1,1,0],29:[0,1,0,0,1,0],30:[1,0,1,1,0,1],31:[0,0,1,1,1,0],32:[0,1,1,1,0,0],33:[0,0,1,1,1,1],34:[1,1,1,1,0,0],35:[0,0,0,1,0,1],36:[1,0,1,0,0,0],37:[1,0,1,0,1,1],38:[1,1,0,1,0,1],39:[0,0,1,0,1,0],40:[0,1,0,1,0,0],41:[1,1,0,0,0,1],42:[0,0,0,1,1,0],43:[1,1,1,1,1,0],44:[0,1,1,1,1,1],45:[0,0,0,1,1,0],46:[0,1,1,0,0,0],47:[0,1,1,0,1,0],48:[0,1,0,1,1,0],49:[1,0,1,0,1,1],50:[1,1,0,1,0,1],51:[0,0,1,0,0,1],52:[1,0,0,1,0,0],53:[0,0,1,1,1,0],54:[0,1,1,0,0,1],55:[1,0,1,0,0,1],56:[1,0,0,1,0,1],57:[0,1,1,0,1,1],58:[1,1,0,1,1,0],59:[0,1,0,1,1,0],60:[0,1,1,0,1,0],61:[1,1,0,0,1,1],62:[0,0,1,1,0,0],63:[1,0,1,0,1,0],64:[0,1,0,1,0,1]};
                return hexBinary[hexNumber] || [1,1,1,1,1,1];
            };

            const calculateHexagram = () => {
                if (!datetime || !question) { alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!'); return; }
                setIsCalculating(true);
                setTimeout(() => {
                    const date = new Date(datetime);
                    const y = date.getFullYear(), m = date.getMonth()+1, d = date.getDate(), h = date.getHours(), min = date.getMinutes();
                    const upper = ((y+m+d)%8)||8, lower = ((y+m+d+h)%8)||8, changing = ((y+m+d+h+min)%6)||6;
                    const mainHexNum = hexagramTable[upper-1][lower-1];
                    const mainLines = getHexagramLines(mainHexNum);
                    const changedLines = [...mainLines];
                    changedLines[changing-1] = 1-changedLines[changing-1];
                    let changedHexNum = mainHexNum;
                    for(let i=1;i<=64;i++){if(JSON.stringify(getHexagramLines(i))===JSON.stringify(changedLines)){changedHexNum=i;break;}}
                    const mainHex = hexagrams[mainHexNum];
                    const changedHex = hexagrams[changedHexNum];
                    const yingYao = mainHex.shiYao<=3?mainHex.shiYao+3:mainHex.shiYao-3;
                    setHexagram({mainHex:{...mainHex,lines:mainLines},mainHexNum,changedHex:{...changedHex,lines:changedLines},changedHexNum,changingLine:changing,shiYao:mainHex.shiYao,yingYao,datetime:date.toLocaleString('vi-VN'),question});
                    setIsCalculating(false);
                },800);
            };

            const getAIInterpretation = async () => {
                if(!user){alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');setShowAuth(true);return;}
                if(profile?.credits_remaining<=0){alert('B·∫°n ƒë√£ h·∫øt l∆∞·ª£t b·ªëc qu·∫ª mi·ªÖn ph√≠!');return;}
                setIsLoadingAI(true);
                setError('');
                try{
                    const res = await fetch('/api/interpret',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:hexagram.question,datetime:hexagram.datetime,mainHexName:hexagram.mainHex.name,mainHexNumber:hexagram.mainHexNum,mainHexPalace:hexagram.mainHex.palace,mainHexElement:hexagram.mainHex.element,changedHexName:hexagram.changedHex.name,changedHexNumber:hexagram.changedHexNum,changingLine:hexagram.changingLine,shiYao:hexagram.shiYao,yingYao:hexagram.yingYao})});
                    const data = await res.json();
                    if(!res.ok){setError(data.error||'L·ªói');return;}
                    setAiInterpretation(data.interpretation);
                    await fetchProfile(user.id);
                }catch(e){setError('L·ªói: '+e.message);}finally{setIsLoadingAI(false);}
            };

            const HexagramVisual = ({lines,changingLine,isMain}) => (
                <div className="hexagram-visual">
                    {[...lines].reverse().map((line,i)=>{
                        const pos=6-i;
                        return <div key={i} className={`hexagram-line ${line===1?'yang':'yin'}`} title={`H√†o ${pos}`}/>;
                    })}
                </div>
            );

            return (
                <div className="container">
                    <div className="auth-bar">
                        {user ? (
                            <div className="user-info">
                                <span>üë§ {profile?.email}</span>
                                <span className="credits-badge">‚ö° C√≤n {profile?.credits_remaining||0} l·∫ßn</span>
                                <button onClick={handleLogout} className="btn btn-secondary">ƒêƒÉng xu·∫•t</button>
                            </div>
                        ) : (
                            <button onClick={()=>setShowAuth(true)} className="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
                        )}
                    </div>

                    <div className="header">
                        <div className="title">ü™∑ Kinh D·ªãch AI ü™∑</div>
                        <div className="subtitle">Authenticated Version</div>
                    </div>

                    {showAuth && (
                        <div className="modal-overlay" onClick={()=>setShowAuth(false)}>
                            <div className="modal" onClick={e=>e.stopPropagation()}>
                                <div className="modal-title">{isLogin?'ƒêƒÉng nh·∫≠p':'ƒêƒÉng k√Ω'}</div>
                                <form onSubmit={isLogin?handleLogin:handleSignup}>
                                    {!isLogin && (
                                        <div className="form-group">
                                            <label className="label">H·ªç t√™n</label>
                                            <input className="input" value={fullName} onChange={e=>setFullName(e.target.value)} required/>
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label className="label">Email</label>
                                        <input type="email" className="input" value={email} onChange={e=>setEmail(e.target.value)} required/>
                                    </div>
                                    <div className="form-group">
                                        <label className="label">M·∫≠t kh·∫©u</label>
                                        <input type="password" className="input" value={password} onChange={e=>setPassword(e.target.value)} required/>
                                    </div>
                                    {authError && <div className="error">{authError}</div>}
                                    {authSuccess && <div className="success">{authSuccess}</div>}
                                    <button type="submit" className="btn btn-primary btn-large">{isLogin?'ƒêƒÉng nh·∫≠p':'ƒêƒÉng k√Ω'}</button>
                                    <div style={{textAlign:'center',marginTop:'1rem'}}>
                                        <a href="#" onClick={e=>{e.preventDefault();setIsLogin(!isLogin);setAuthError('');}}>{isLogin?'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω':'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p'}</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <div className="card-header">üìø B·ªëc Qu·∫ª</div>
                        <div className="form-group">
                            <label className="label">‚è∞ Gi·ªù ƒê·ªông T√¢m</label>
                            <input type="datetime-local" className="input" value={datetime} onChange={e=>setDatetime(e.target.value)}/>
                        </div>
                        <div className="form-group">
                            <label className="label">üí≠ C√¢u H·ªèi</label>
                            <textarea className="textarea" value={question} onChange={e=>setQuestion(e.target.value)} placeholder="Nh·∫≠p c√¢u h·ªèi..."/>
                        </div>
                        <div className="button-group">
                            <button onClick={calculateHexagram} disabled={isCalculating} className="btn btn-primary btn-large">
                                {isCalculating?<><span className="spinner"/> ƒêang t√≠nh...</>:'üîÆ B·ªëc Qu·∫ª'}
                            </button>
                            <button onClick={()=>{setHexagram(null);setAiInterpretation('');setDatetime('');setQuestion('');}} className="btn btn-secondary">üîÑ L√†m l·∫°i</button>
                        </div>
                    </div>

                    {hexagram && (
                        <div className="fade-in">
                            <div className="card">
                                <div className="card-header">üéã Qu·∫ª T∆∞·ª£ng</div>
                                <div className="hexagram-grid">
                                    <div className="hexagram-card hexagram-main">
                                        <h3 style={{color:'#dc2626',marginBottom:'1rem'}}>üî¥ Qu·∫ª Ch√≠nh</h3>
                                        <HexagramVisual lines={hexagram.mainHex.lines} changingLine={hexagram.changingLine} isMain={true}/>
                                        <div className="hexagram-name" style={{color:'#991b1b'}}>{hexagram.mainHex.name}</div>
                                        <div>Qu·∫ª {hexagram.mainHexNum}/64</div>
                                    </div>
                                    <div className="hexagram-card hexagram-changed">
                                        <h3 style={{color:'#3b82f6',marginBottom:'1rem'}}>üîµ Qu·∫ª Bi·∫øn</h3>
                                        <HexagramVisual lines={hexagram.changedHex.lines} changingLine={null} isMain={false}/>
                                        <div className="hexagram-name" style={{color:'#1e40af'}}>{hexagram.changedHex.name}</div>
                                        <div>Qu·∫ª {hexagram.changedHexNum}/64</div>
                                    </div>
                                </div>
                                <button onClick={getAIInterpretation} disabled={isLoadingAI || !user} className="btn btn-primary btn-large">
                                    {isLoadingAI?<><span className="spinner"/> ƒêang lu·∫≠n gi·∫£i...</>:'ü§ñ Nh·∫≠n L·ªùi Gi·∫£i'}
                                </button>
                                {error && <div className="error" style={{marginTop:'1rem'}}>{error}</div>}
                            </div>
                            {aiInterpretation && (
                                <div className="card fade-in">
                                    <div className="card-header" style={{color:'#7c3aed'}}>üìú L·ªùi Gi·∫£i</div>
                                    <div className="interpretation">{aiInterpretation}</div>
                                    <div className="note">üí° L·ªùi gi·∫£i ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠ c·ªßa b·∫°n.</div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<KinhDichApp />, document.getElementById('root'));
    </script>
</body>
</html>
